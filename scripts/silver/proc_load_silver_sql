/*
================================================================================
  Stored Procedure: Silver.load_silver
  Layer: Bronze → Silver
================================================================================
 Script Purpose:
    This stored procedure performs the ETL (Extract, Transform, Load) operation to populate tables in the Silver schema using data from the Bronze schema.
    It standardizes, cleans, and prepares raw data for downstream analytics and reporting.
Actions Performed
  	•	Truncates existing tables in the Silver schema to ensure a fresh load
  	•	Extracts raw data from Bronze schema tables
  	•	Applies data transformations and cleansing rules
  	•	Inserts the processed data into corresponding Silver schema tables
    
Parameters

    None.
    This stored procedure does not accept input parameters and does not return any values.
    
usage example:
    Exec silver.load_silver;
================================================================================
*/


PRINT '>> truncating table: silver.crm_cust_info';
TRUNCATE TABLE silver.crm_cust_info;

PRINT '>> inserting data into: silver.crm_cust_info';
INSERT INTO silver.crm_cust_info (
    cst_id,
    cst_key,
    cst_firstname,
    cst_lastname,
    cst_marital_status,
    cst_gndr,
    cst_create_date
)
SELECT 
    cst_id,
    cst_key,
    TRIM(cst_firstname),
    TRIM(cst_lastname),
    CASE 
        WHEN UPPER(TRIM(cst_marital_status)) = 'S' THEN 'single'
        WHEN UPPER(TRIM(cst_marital_status)) = 'M' THEN 'married'
        ELSE 'N/A'
    END,
    CASE 
        WHEN UPPER(TRIM(cst_gndr)) = 'F' THEN 'female'
        WHEN UPPER(TRIM(cst_gndr)) = 'M' THEN 'male'
        ELSE 'other'
    END,
    cst_create_date
FROM (
    SELECT *,
           ROW_NUMBER() OVER (
               PARTITION BY cst_id 
               ORDER BY cst_create_date DESC
           ) rn
    FROM bronze.crm_cust_info
) t
WHERE rn = 1;

PRINT '>> truncating table: silver.crm_prd_info';
TRUNCATE TABLE silver.crm_prd_info;

PRINT '>> inserting data into: silver.crm_prd_info';
INSERT INTO silver.crm_prd_info (
    prd_id,
    prd_key,
    cat_id,
    prd_nm,
    prd_line,
    prd_start_dt,
    prd_end_dt
)
SELECT
    prd_id,
    SUBSTRING(prd_key, 7, LEN(prd_key)),
    REPLACE(SUBSTRING(prd_key, 1, 5), '-', '_'),
    prd_nm,
    CASE 
        WHEN UPPER(TRIM(prd_line)) = 'M' THEN 'Mountain'
        WHEN UPPER(TRIM(prd_line)) = 'R' THEN 'Road'
        WHEN UPPER(TRIM(prd_line)) = 'S' THEN 'Other Sales'
        WHEN UPPER(TRIM(prd_line)) = 'T' THEN 'Touring'
        ELSE 'N/A'
    END,
    CAST(prd_start_dt AS DATE),
    CAST(
        DATEADD(
            DAY, -1,
            LEAD(prd_start_dt) OVER (
                PARTITION BY prd_key 
                ORDER BY prd_start_dt
            )
        ) AS DATE
    )
FROM bronze.crm_prd_info;

PRINT '>> truncating table: silver.crm_sales_details';
TRUNCATE TABLE silver.crm_sales_details;

PRINT '>> inserting data into: silver.crm_sales_details';
INSERT INTO silver.crm_sales_details (
    sls_ord_num,
    sls_prd_key,
    sls_cust_id,
    sls_order_dt,
    sls_ship_dt,
    sls_due_dt,
    sls_sales,
    sls_quantity,
    sls_price
)
SELECT
    sls_ord_num,
    sls_prd_key,
    sls_cust_id,
    TRY_CONVERT(DATE, sls_order_dt, 112),
    TRY_CONVERT(DATE, sls_ship_dt, 112),
    TRY_CONVERT(DATE, sls_due_dt, 112),
    CASE
        WHEN sls_sales IS NULL
          OR sls_sales <= 0
          OR sls_sales <> sls_quantity * ABS(sls_price)
        THEN sls_quantity * ABS(sls_price)
        ELSE sls_sales
    END,
    sls_quantity,
    CASE
        WHEN sls_price IS NULL OR sls_price <= 0
        THEN sls_sales / NULLIF(sls_quantity, 0)
        ELSE sls_price
    END
FROM bronze.crm_sales_details
WHERE sls_prd_key IN (
    SELECT prd_key FROM silver.crm_prd_info
);

PRINT '>> truncating table: silver.erp_cust_az12';
TRUNCATE TABLE silver.erp_cust_az12;

INSERT INTO silver.erp_cust_az12 (cid, bdate, gen)
SELECT
    CASE 
        WHEN cid LIKE 'NAS%' THEN SUBSTRING(cid, 4, LEN(cid))
        ELSE cid
    END,
    CASE 
        WHEN bdate > GETDATE() THEN NULL
        ELSE bdate
    END,
    CASE
        WHEN UPPER(TRIM(gen)) IN ('F','FEMALE') THEN 'Female'
        WHEN UPPER(TRIM(gen)) IN ('M','MALE') THEN 'Male'
        ELSE 'N/A'
    END
FROM bronze.erp_cust_az12;

PRINT '>> truncating table: silver.erp_loc_a101';
TRUNCATE TABLE silver.erp_loc_a101;

INSERT INTO silver.erp_loc_a101 (cid, cntry)
SELECT
    REPLACE(cid, '-', ''),
    CASE 
        WHEN UPPER(TRIM(cntry)) = 'DE' THEN 'Germany'
        WHEN UPPER(TRIM(cntry)) IN ('US','USA') THEN 'United States'
        WHEN cntry IS NULL OR TRIM(cntry) = '' THEN 'N/A'
        ELSE TRIM(cntry)
    END
FROM bronze.erp_loc_a101;
